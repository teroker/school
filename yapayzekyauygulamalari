import csv
import tkinter as tk
from tkinter import messagebox, simpledialog
import os

class StokYonetimSistemi:
    def __init__(self, dosya_adi="stok_listesi.csv"):
        self.dosya_adi = dosya_adi
        self.tedarikci = {
            "ad": "ABC GÄ±da DaÄŸÄ±tÄ±m A.Å.",
            "mail": "siparis@abcgida.com",
            "tel": "+90 212 555 10 10"
        }
        
        # 1. ADIM: Verileri dosyadan yÃ¼kle (EÄŸer dosya yoksa varsayÄ±lanlarÄ± kullan)
        self.urunler = self.verileri_yukle()
        
        # Ana Pencere
        self.root = tk.Tk()
        self.root.title("Stok Takip Sistemi (KalÄ±cÄ± KayÄ±t)")
        self.root.geometry("350x320")
        self.arayuz_hazirla()

    def verileri_yukle(self):
        """Program aÃ§Ä±ldÄ±ÄŸÄ±nda CSV dosyasÄ±ndaki verileri okur."""
        varsayilan_urunler = {
            "Ã‡ay": 15, "Su": 2, "Makarna": 20, "Ekmek": 3, "SÃ¼t": 12,
            "Ã‡ikolata": 8, "Dondurma": 1, "Kola": 10, "Fanta": 4, "PirinÃ§": 25
        }
        
        if os.path.exists(self.dosya_adi):
            try:
                yuklenen_urunler = {}
                with open(self.dosya_adi, mode='r', encoding='utf-8-sig') as file:
                    reader = csv.reader(file)
                    next(reader) # BaÅŸlÄ±k satÄ±rÄ±nÄ± atla
                    for satir in reader:
                        if satir: # BoÅŸ satÄ±r kontrolÃ¼
                            urun_adi, miktar = satir[0], int(satir[1])
                            yuklenen_urunler[urun_adi] = miktar
                print(">> [SÄ°STEM] Veriler dosyadan baÅŸarÄ±yla yÃ¼klendi.")
                return yuklenen_urunler
            except Exception as e:
                print(f">> [UYARI] Dosya okunurken hata oluÅŸtu, varsayÄ±lanlar yÃ¼kleniyor: {e}")
                return varsayilan_urunler
        else:
            print(">> [SÄ°STEM] KayÄ±t dosyasÄ± bulunamadÄ±, varsayÄ±lan liste oluÅŸturuldu.")
            return varsayilan_urunler

    def arayuz_hazirla(self):
        tk.Label(self.root, text="ğŸ“¦ STOK KONTROL MERKEZÄ°", font=("Arial", 12, "bold")).pack(pady=15)
        
        tk.Button(self.root, text="ğŸ“‹ Stok Listesini GÃ¶r", command=self.stoklari_listele, width=28).pack(pady=5)
        tk.Button(self.root, text="â• ÃœrÃ¼n Ekle / GÃ¼ncelle", command=self.urun_ekle_popup, width=28, bg="#d4edda").pack(pady=5)
        tk.Button(self.root, text="âŒ ÃœrÃ¼n Sil", command=self.urun_sil_popup, width=28, bg="#f8d7da").pack(pady=5)
        tk.Button(self.root, text="ğŸ’¾ Kaydet ve SipariÅŸ OluÅŸtur", command=self.kaydet_ve_siparis_kontrol, width=28, bg="#cce5ff", font=("Arial", 9, "bold")).pack(pady=20)

    def terminal_tablo_yazdir(self):
        print("\n" + "="*40)
        print(f"{'ÃœRÃœN ADI':<20} | {'STOK ADEDÄ°'}")
        print("-" * 40)
        for urun, miktar in self.urunler.items():
            durum = " <-- KRÄ°TÄ°K" if miktar <= 5 else ""
            print(f"{urun:<20} | {miktar:<10} {durum}")
        print("="*40 + "\n")

    def stoklari_listele(self):
        liste_penceresi = tk.Toplevel(self.root)
        liste_penceresi.title("Mevcut Stok")
        liste_penceresi.geometry("300x380")
        metin_alani = tk.Text(liste_penceresi, font=("Courier New", 10))
        metin_alani.pack(padx=10, pady=10, fill="both", expand=True)
        tablo_metni = f"{'ÃœRÃœN':<15} | {'STOK'}\n" + "-"*25 + "\n"
        for u, m in self.urunler.items():
            tablo_metni += f"{u:<15} | {m}\n"
        metin_alani.insert("1.0", tablo_metni)
        metin_alani.config(state="disabled")

    def urun_ekle_popup(self):
        ad = simpledialog.askstring("ÃœrÃ¼n GiriÅŸi", "ÃœrÃ¼n AdÄ±:", parent=self.root)
        if ad:
            miktar = simpledialog.askinteger("Stok GiriÅŸi", f"{ad} iÃ§in miktar:", parent=self.root)
            if miktar is not None:
                self.urunler[ad] = miktar
                print(f">> [LOG] {ad} listeye eklendi/gÃ¼ncellendi.")

    def urun_sil_popup(self):
        ad = simpledialog.askstring("ÃœrÃ¼n Sil", "Silinecek Ã¼rÃ¼n adÄ±:", parent=self.root)
        if ad in self.urunler:
            del self.urunler[ad]
            print(f">> [LOG] {ad} silindi.")
        elif ad:
            messagebox.showerror("Hata", f"'{ad}' bulunamadÄ±!")

    def siparis_taslagi_goster(self, kritik_listesi):
        taslak_penceresi = tk.Toplevel(self.root)
        taslak_penceresi.title("SipariÅŸ Formu")
        taslak_penceresi.geometry("400x400")
        taslak_metni = f"Kime: {self.tedarikci['mail']}\nKonu: Stok SipariÅŸi\n\nÃœrÃ¼nler:\n"
        for urun in kritik_listesi:
            taslak_metni += f"- {urun}: ({self.urunler[urun]} adet kaldÄ±)\n"
        txt = tk.Text(taslak_penceresi, font=("Arial", 10), padx=10, pady=10)
        txt.pack(fill="both", expand=True)
        txt.insert("1.0", taslak_metni)
        txt.config(state="disabled")

    def kaydet_ve_siparis_kontrol(self):
        try:
            # 2. ADIM: GÃ¼ncel sÃ¶zlÃ¼ÄŸÃ¼ CSV'ye yaz (KalÄ±cÄ± kayÄ±t burasÄ±)
            with open(self.dosya_adi, mode='w', newline='', encoding='utf-8-sig') as file:
                writer = csv.writer(file)
                writer.writerow(['ÃœrÃ¼n AdÄ±', 'Stok MiktarÄ±'])
                for u, m in self.urunler.items():
                    writer.writerow([u, m])
            
            self.terminal_tablo_yazdir()
            kritikler = [u for u, m in self.urunler.items() if m <= 5]
            
            if kritikler:
                if messagebox.askyesno("Kritik Durum", "DÃ¼ÅŸÃ¼k stoklar var. SipariÅŸ taslaÄŸÄ± aÃ§Ä±lsun mu?"):
                    self.siparis_taslagi_goster(kritikler)
                else:
                    self.root.destroy()
            else:
                messagebox.showinfo("BaÅŸarÄ±lÄ±", "TÃ¼m deÄŸiÅŸiklikler kaydedildi.")
                self.root.destroy()

        except Exception as e:
            messagebox.showerror("Hata", f"Kaydedilemedi: {e}")

if __name__ == "__main__":
    app = StokYonetimSistemi()
    app.root.mainloop()
